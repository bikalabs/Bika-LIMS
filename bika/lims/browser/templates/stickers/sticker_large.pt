<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<metal:block use-macro="context/global_defines/macros/defines" />

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      tal:attributes="lang default_language|default;
                      xml:lang default_language|default;"
      i18n:domain="bika"
      tal:define="portal_state context/@@plone_portal_state;
                  portal_url portal_state/portal_url;
                  plone_view context/@@plone;">

<head>
    <div tal:replace="structure provider:plone.resourceregistries.scripts" />
    <style type="text/css">
        body {
            background-color: #efefef;
            margin: 0;
            padding: 0;
        }
        table {
            border-collapse:collapse;
            margin: 1px 1px 1px 1px;
            font-size: 6pt;
            width:100%;
        }
        th {
            text-align: left;
            text-transform: none;
            border: 1pt solid #888;
            padding:0.5mm;
        }
        td {
            border: 1pt solid #888;
            padding:0.5mm;
        }
        .stickers-wrapper {
            font-family:Helvetica, Arial;
            font-size:6pt;
            margin-top: 5mm;
        }
        .sticker-wrapper {
            margin:0 auto;
            background-color:#fff;
            border-bottom: 1px dotted #cdcdcd;
            box-shadow: 1px 2px 5px #cdcdcd;
        }
        .sticker-wrapper.code128,
        .sticker-wrapper.code39 {
            padding: 1mm;
        }
        .sticker-wrapper.code128 {
              width: 70mm;
        }
        .sticker-wrapper.code39 {
              width: 70mm;
        }
        .sticker-wrapper.code128 .sample-id,
        .sticker-wrapper.code39 .sample-id {
            height: 5mm;
            text-align:center;
        }
        .sticker-wrapper.qr {
            text-align: center;
            width: 70mm;
        }
        .goback-top, .goback-bottom {
            margin: 20px auto;
            text-align: center;
            width: 50mm;
        }
        .goback-top > a,
        .goback-bottom > a {
          background-color: #aaa;
          border-radius: 5px;
          color: #fff;
          font-family: Helvetica,Arial;
          font-size: 9pt;
          font-weight: bold;
          padding: 4px 15px;
          text-decoration: none;
          text-shadow: 1px 1px 1px #999;
          text-transform: uppercase;
        }
        .goback-top.noprint > a:hover,
        .goback-bottom > a:hover {
            background-color: #bbb;
            text-shadow: 1px 1px 1px #aaa;
        }
        .barcode {
            margin:0 auto;
        }
        @media print {
            .noprint {display:none !important;}
            body {background-color:#fff;}
            .sticker-wrapper {
              margin:0;
              border:none;
              box-shadow:none;
              border-bottom:none;
            }
        }
    </style>
</head>

<body style="margin: 0; padding: 0" onload="this.print();"
      tal:define="stickerformat     view/StickerFormatCode;
                  portal_url        nocall:context/portal_url;
                  show_partitions   python:context.bika_setup.getShowPartitions();
                  portal_type       python:context.portal_type;
                  anchor_self       python:('Client','AnalysisRequest', 'AnalysisRequestsFolder', 'Batch');
                  backurl           python:context.absolute_url() if portal_type in anchor_self else context.aq_parent.absolute_url();">

    <!-- Go back's paragraph -->
    <div class='goback-top noprint'>
        <a tal:attributes="href backurl" id='goback' i18n:translate="">Go back</a>
    </div>

    <div class='stickers-wrapper'>
        <!-- Iterate through all partitions -->
        <div tal:repeat="item view/items"
             tal:attributes="class python:'sticker-wrapper %s' % stickerformat.lower()">
             <div class="sticker"
                  tal:define="
                  ar           python:item[0];
                  ar_id        python:ar.getId() if ar else '';
                  sample       python:item[1];
                  part         python:item[2];
                  partnr       python:part.getId().split('-')[1];
                  sample       python:part.aq_parent;
                  CSID         python:sample.getClientSampleID();
                  Order        python:sample.getAnalysisRequests()[0].getClientOrderNumber();
                  Hazardous    python:sample.getSampleType().getHazardous();
                  SampleType   python:sample.getSampleType().Title();
                  Sampler      python:sample.getSampler();
                  SampleType   python:sample.getSampleType().Title();
                  SamplePoint  python:sample.getSamplePoint() and sample.getSamplePoint().Title() or '';
                  Preservation python:part.getPreservation() and part.getPreservation().Title() or '';
                  Container    python:part.getContainer() and part.getContainer().Title() or '';
                  SamplingDate python:sample.getSamplingDate() and sample.getSamplingDate().Date();
                  Deviation    python:sample.getSamplingDeviation() and sample.getSamplingDeviation().Title() or '';
                  DateSampled  python:sample.getDateSampled() and sample.getDateSampled().Date();
                  Composite    python:sample.getComposite();
                  AdHoc        python:sample.getAdHoc();
                  analyses     python:part.getBackReferences('AnalysisSamplePartition');
                  field_analyses  python:[analysis for analysis in analyses if analysis.getService().getPointOfCapture()=='field'];
                  smart_id     python:part.getId() if show_partitions else sample.getId();
                  hazardous         python:sample.getSampleType().getHazardous();">

                  <table cellpadding="0" cellspacing="0">
                      <thead>
                          <tr>
                              <th i18n:translate="">Sample ID</th>
                              <td><strong tal:content="string:${smart_id}"/></td>
                              <th i18n:translate="">Hazardous</th>
                              <td tal:content="Hazardous"/>
                          </tr>
                          <tr>
                              <th i18n:translate="">Sampling Date</th>
                              <td tal:content="SamplingDate"/>
                              <th i18n:translate="">Sampler</th>
                              <td tal:content="Sampler"/>
                          </tr>
                          <tr>
                              <th i18n:translate="">CSID</th>
                              <td tal:content="CSID"/>
                              <th i18n:translate="">Order</th>
                              <td tal:content="Order"/>
                          </tr>
                          <tr>
                              <th i18n:translate="">Deviation</th>
                              <td tal:content="Deviation"/>
                              <th i18n:translate="">Composite</th>
                              <td class="left" tal:content="Composite"/>
                          </tr>
                          <tr>
                              <th i18n:translate="">Container</th>
                              <td tal:content="Container"/>
                              <th i18n:translate="">Preservation</th>
                              <td tal:content="Preservation"/>
                          </tr>
                          <tr>
                              <th i18n:translate="">Sample Type</th>
                              <td colspan='3' tal:content="SampleType"/>
                          </tr>
                          <tr>
                              <th i18n:translate="">Sample Point</th>
                              <td colspan='3' tal:content="SamplePoint"/>
                          </tr>
                          <tr tal:condition="python:field_analyses">
                              <th colspan="4" i18n:translate="">Field Analyses</th>
                          </tr>
                          <tal:block repeat="analysis python:field_analyses">
                          <tr>
                              <td colspan="4" tal:content="python:analysis.getService().Title()"/>
                          </tr>
                          </tal:block>

                          <!-- Barcode-type sticker -->
                          <tr tal:condition="python:stickerformat != 'QR'">
                              <td colspan="4">
                                  <!-- Barcode -->
                                  <div class="barcode"
                                      tal:attributes="data-id     smart_id;
                                                      data-code   stickerformat;"
                                      data-barHeight="12"
                                      data-addQuietZone="true"
                                      data-showHRI="false">
                                  </div>
                              </td>
                          </tr>
                          <!-- To render when QR enabled -->
                          <tr tal:condition="python: stickerformat == 'QR'">
                              <td colspan="4">
                                  <div class='qrcode'
                                       data-size="50"
                                       tal:attributes="data-code ar_id"></div>
                              </td>
                          </tr>
                      </thead>
                  </table>
            </div>
        </div>
        <div style='page-break: always'/>
    </div>

    <!-- Go back's paragraph -->
    <div class='goback-bottom noprint'>
        <a tal:attributes="href backurl" id='goback' i18n:translate="">Go back</a>
    </div>
</body>
</html>
