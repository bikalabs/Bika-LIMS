<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<metal:block use-macro="context/global_defines/macros/defines" />

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      tal:attributes="lang default_language|default;
                      xml:lang default_language|default;"
      i18n:domain="bika"
      tal:define="portal_state context/@@plone_portal_state;
                  portal_url portal_state/portal_url;
                  plone_view context/@@plone;">

<head>
    <div tal:replace="structure provider:plone.resourceregistries.scripts" />
    <style type="text/css">
        body {
            background-color: #efefef;
            margin: 0;
            padding: 0;
        }
        .stickers-wrapper {
            font-family:Helvetica, Arial;
            font-size:6pt;
            margin-top: 5mm;
        }
        table {
            border-collapse:collapse;
            margin: 1px 1px 1px 1px;
            font-size: 6pt;
            width:100%;
        }
        td {
            border: none;
        }
        .sticker-wrapper {
            margin:0 auto;
            background-color:#fff;
            border-bottom: 1px dotted #cdcdcd;
            box-shadow: 1px 2px 5px #cdcdcd;
        }
        .sticker-wrapper.code128,
        .sticker-wrapper.code39 {
            padding: 1mm;
        }
        .sticker-wrapper.code128 {
              max-width: 46mm;
        }
        .sticker-wrapper.code39 {
              max-width: 49mm;
        }
        .sticker-wrapper.code128 .sample-id,
        .sticker-wrapper.code39 .sample-id {
            height: 5mm;
            text-align:center;
        }
        .sticker-wrapper.qr {
            height: 21mm;
            padding: 8mm 0 0;
            text-align: center;
            width: 14mm;
        }
        .sticker-wrapper.qr div.requestid {
            padding-top: 2mm;
            line-height: 4mm;
        }
        .sticker-wrapper.qr div.clientsampleid {
            line-height: 4mm;
        }
        .goback-top, .goback-bottom {
            margin: 20px auto;
            text-align: center;
            width: 50mm;
        }
        .goback-top > a,
        .goback-bottom > a {
          background-color: #aaa;
          border-radius: 5px;
          color: #fff;
          font-family: Helvetica,Arial;
          font-size: 9pt;
          font-weight: bold;
          padding: 4px 15px;
          text-decoration: none;
          text-shadow: 1px 1px 1px #999;
          text-transform: uppercase;
        }
        .goback-top.noprint > a:hover,
        .goback-bottom > a:hover {
            background-color: #bbb;
            text-shadow: 1px 1px 1px #aaa;
        }
        @media print {
            .noprint {display:none !important;}
            body {background-color:#fff;}
            .sticker-wrapper {
              margin:0;
              border:none;
              box-shadow:none;
              border-bottom:none;
            }
        }
    </style>
</head>

<body onload="this.print();"
      tal:define="stickerformat     view/StickerFormatCode;
                  portal_url        nocall:context/portal_url;
                  show_partitions   python:context.bika_setup.getShowPartitions();
                  portal_type  python:context.portal_type;
                  anchor_self  python:('Client','AnalysisRequest', 'AnalysisRequestsFolder', 'Batch');
                  backurl      python:context.absolute_url() if portal_type in anchor_self else context.aq_parent.absolute_url();">

    <!-- Go back's paragraph -->
    <div class='goback-top noprint'>
        <a tal:attributes="href backurl" id='goback' i18n:translate="">Go back</a>
    </div>

    <div class='stickers-wrapper'>
        <!-- Iterate through all partitions -->
        <div tal:repeat="item view/items"
             tal:attributes="class python:'sticker-wrapper %s' % stickerformat.lower()">
            <div class="sticker"
                 tal:define="
                  ar                python:item[0];
                  ar_id             python:ar.getId() if ar else '';
                  sample            python:item[1];
                  part              python:item[2];
                  partnr            python:part.getId().split('-')[1];
                  sampler           python:sample.getSampler();
                  sample_id         python:sample.getId();
                  sample_point      python:sample.getSamplePoint() and sample.getSamplePoint().Title() or '';
                  sample_type       python:sample.getSampleType().Title();
                  sampling_date     python:sample.getSamplingDate() and sample.getSamplingDate().Date();
                  client_sample_id  python:sample.getClientSampleID();
                  preservation      python:part.getPreservation() and part.getPreservation().Title() or '';
                  container         python:part.getContainer() and part.getContainer().Title() or '';
                  date_sampled      python:sample.getDateSampled() and sample.getDateSampled().Date();
                  analyses          python:part.getBackReferences('AnalysisSamplePartition');
                  field_analyses    python:[analysis for analysis in analyses if analysis.getService().getPointOfCapture()=='field'];
                  smart_id          python:part.getId() if show_partitions else sample.getId();
                  hazardous         python:sample.getSampleType().getHazardous();">

                <!-- Barcode-type sticker -->
                <tal:barcodesticker condition="python: stickerformat != 'QR'">
                    <!-- Sample ID -->
                    <div class="sample-id">
                        <!--span tal:replace="string:${smart_id}"/-->
                        <img tal:condition="hazardous | nothing"
                             tal:attributes="src string:${portal_url}/++resource++bika.lims.images/hazardous.png"/>
                    </div>

                    <!-- Barcode -->
                    <div class="barcode"
                        tal:attributes="data-id     smart_id;
                                        data-code   stickerformat;"
                        data-barHeight="12"
                        data-addQuietZone="true"
                        data-showHRI="false">
                    </div>

                    <!-- Some additional info about the sample -->
                    <div class="analysisrequest-info">
                        <table cellpadding="0" cellspacing="0" border="0">
                            <tr>
                                <td class="sample-type" tal:content="sample_type"/>
                                <td class="preservation" tal:content="preservation"/>
                                <td class="sample-point" tal:content="sample_point"/>
                            </tr>
                        </table>
                    </div>

                    <!-- Sampling Date -->
                    <div class="sampling-date-info">
                        <table cellpadding="0" cellspacing="0" border="0">
                            <tr>
                                <td class='label' i18n:translate="">Sampling Date</td>
                                <td class='sampling-date' tal:content="sampling_date"></td>
                                <td class='sampler' tal:content="sampler"></td>
                            </tr>
                        </table>
                    </div>
                </tal:barcodesticker>

                <!-- QR-type sticker -->
                <tal:qrcodesticker condition="python: stickerformat == 'QR'">
                    <div class='qrcode'
                         data-size="36"
                         tal:attributes="data-code ar_id"></div>

                    <!-- Analysis request's other info -->
                    <div class="requestid" tal:content="ar_id" tal:condition="ar_id"></div>
                    <div class="clientsampleid" tal:content="client_sample_id"></div>
                </tal:qrcodesticker>
            </div>
        </div>
        <div style='page-break: always'/>
    </div>

    <!-- Go back's paragraph -->
    <div class='goback-bottom noprint'>
        <a tal:attributes="href backurl" id='goback' i18n:translate="">Go back</a>
    </div>
</body>
</html>
